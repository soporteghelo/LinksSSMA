<script>
  // --- Config ---
  const FALLBACK_IMAGE = "https://images.unsplash.com/photo-1518623489648-a173ef7824f3?auto=format&fit=crop&q=80&w=800"; // Generic Industrial
  const EMERGENCY_IMAGE_URL = 'https://lh3.googleusercontent.com/d/1S4WjOgDQKLdOxyrZPr4WFbq-MPv-OVXT'; // Imagen del flujo de emergencia

  // Category Icons Mapping
  const CATEGORY_ICONS = {
    'PETS': 'description',
    'Estándares': 'rule',
    'IPERC': 'warning_amber',
    'Capacitación': 'school',
    'Examen': 'quiz',
    'Otros': 'folder'
  };

  // --- State ---
  let appData = [];
  let groupedData = {};
  let carouselInterval;
  let currentSlide = 0;
  let touchStartX = 0;
  let touchEndX = 0;
  let searchTimeout = null; // Variable para Debounce
  let currentCategoryItems = []; // Para Paginación
  let displayedItemsCount = 0; // Para Paginación
  const ITEMS_PER_PAGE = 12; // Para Paginación

  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', () => {
    // Fetch data from Google Apps Script Backend
    google.script.run
      .withSuccessHandler(onDataSuccess)
      .withFailureHandler(onDataFailure)
      .getActiveData();

    // Event Listeners
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });

    // Emergency Modal Close on backdrop click
    document.getElementById('emergencyModal').addEventListener('click', (e) => {
      if (e.target.id === 'emergencyModal') closeEmergencyModal();
    });

    document.getElementById('searchInput').addEventListener('input', handleSearchDebounced);
    initGlobalLanternEffect();

  });

  function initGlobalLanternEffect() {
    if (window.innerWidth < 768) return; // SOLO DESKTOP
    const target = document.body;
    if (!target) return;

    const setPosition = (clientX, clientY) => {
      target.style.setProperty('--x', `${clientX}px`);
      target.style.setProperty('--y', `${clientY}px`);
    };

    document.addEventListener('mousemove', (e) => {
      setPosition(e.clientX, e.clientY);
    });

    document.addEventListener('touchstart', (e) => {
      if (!e.touches || e.touches.length === 0) return;
      setPosition(e.touches[0].clientX, e.touches[0].clientY);
      target.classList.add('is-touch-active');
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
      if (!e.touches || e.touches.length === 0) return;
      setPosition(e.touches[0].clientX, e.touches[0].clientY);
      target.classList.add('is-touch-active');
    }, { passive: true });

    document.addEventListener('touchend', () => {
      target.classList.remove('is-touch-active');
    });
  }

  function applyLanternEffect(element) {
    if (window.innerWidth < 768) return; // SOLO DESKTOP
    const updateLantern = (clientX, clientY) => {
      const rect = element.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      element.style.setProperty('--mouse-x', `${x}px`);
      element.style.setProperty('--mouse-y', `${y}px`);
    };

    element.addEventListener('mousemove', (e) => {
      updateLantern(e.clientX, e.clientY);
      element.classList.add('is-lit');
    });

    element.addEventListener('mouseleave', () => {
      element.classList.remove('is-lit');
    });

    element.addEventListener('touchstart', (e) => {
      if (!e.touches || e.touches.length === 0) return;
      updateLantern(e.touches[0].clientX, e.touches[0].clientY);
      element.classList.add('is-lit');
    }, { passive: true });

    element.addEventListener('touchmove', (e) => {
      if (!e.touches || e.touches.length === 0) return;
      updateLantern(e.touches[0].clientX, e.touches[0].clientY);
      element.classList.add('is-lit');
    }, { passive: true });

    element.addEventListener('touchend', () => {
      element.classList.remove('is-lit');
    });
  }

  function onDataSuccess(data) {
    console.log("Data received from backend:", data); // Debugging
    if (!data || data.length === 0) {
      console.warn("No data received or empty array.");
      showEmptyState(true);
      hideLoader();
      return;
    }
    initApp(data);
  }

  function onDataFailure(error) {
    console.error("Error fetching data:", error);
    hideLoader();
    const container = document.getElementById('dashboardView'); // Show error effectively
    container.innerHTML = `<div class="text-center text-red-500 p-8">Error al cargar datos. Por favor recarga la página. <br> ${error.message}</div>`;
    container.classList.remove('hidden');
  }

  function initApp(data) {
    appData = data; // Data is already filtered by 'Activo' in backend

    // Process Data
    const comunicados = appData.filter(item => item.CATEGORIA === 'Comunicado').sort((a, b) => (Number(a.ORDEN) || 0) - (Number(b.ORDEN) || 0));
    const others = appData.filter(item => item.CATEGORIA !== 'Comunicado');

    groupedData = groupAndSort(others);

    renderHero(comunicados);
    renderDashboard(groupedData); // Initial View

    hideLoader();
  }

  function groupAndSort(data) {
    const groups = data.reduce((acc, item) => {
      const cat = item.CATEGORIA || 'Otros';
      if (!acc[cat]) acc[cat] = [];
      acc[cat].push(item);
      return acc;
    }, {});

    Object.keys(groups).forEach(cat => {
      groups[cat].sort((a, b) => (Number(a.ORDEN) || 999) - (Number(b.ORDEN) || 999));
    });

    return groups;
  }

  // --- Render Functions ---

  function renderHero(items) {
    const container = document.getElementById('heroSection');
    const innerContainer = document.getElementById('carouselContainer');
    const indicators = document.getElementById('carouselIndicators');

    if (!items || items.length === 0) {
      container.classList.add('hidden');
      return;
    }

    container.classList.remove('hidden');
    innerContainer.innerHTML = '';
    indicators.innerHTML = '';

    // Render Slides
    items.forEach((item, index) => {
      const isHidden = index === 0 ? '' : 'carousel-hidden opacity-0';

      const slide = document.createElement('div');
      slide.className = `absolute inset-0 w-full h-full transition-opacity duration-1000 ease-in-out ${isHidden}`;
      slide.dataset.index = index;
      slide.onclick = () => openModal(item);

      slide.innerHTML = `
                 <div class="relative w-full h-full cursor-pointer">
                    <img src="${item.LINK_FOTO || FALLBACK_IMAGE}" alt="Comunicado" loading="lazy" class="w-full h-full object-cover" onerror="this.src='${FALLBACK_IMAGE}'">
                    
                    <div class="absolute inset-0 z-20 flex flex-col justify-end items-start px-6 md:px-12 pb-5 md:pb-7 max-w-4xl">
                        <button class="absolute top-4 right-4 bg-white text-aesa-dark hover:bg-gray-100 font-bold py-1.5 px-4 rounded text-xs transition-all flex items-center gap-1 shadow-md">
                            LEER MÁS
                            <span class="material-icons text-[10px]">arrow_forward</span>
                        </button>
                        <span class="absolute top-4 left-6 md:left-12 inline-flex items-center gap-1.5 self-start px-2 py-0.5 rounded-full bg-red-700 text-white text-[10px] font-bold uppercase tracking-wider mb-2 shadow-sm animate-pulse">
                            <span class="material-icons text-[10px]">campaign</span> 
                            Comunicado
                        </span>
                        <div class="self-start max-w-2xl translate-y-2 md:translate-y-3">
                        <h2 class="bg-black/50 rounded-md px-3 py-1.5 self-start max-w-2xl text-xl md:text-3xl font-bold text-white mb-1 leading-[0.6] font-condensed line-clamp-1">
                                ${item.TITULO}
                            </h2>
                            <p class="bg-black/50 rounded-md px-3 py-1.5 self-start max-w-2xl text-gray-200 text-xs md:text-sm line-clamp-2 mb-0 leading-[0.7]">
                                ${item.DESCRIPCION_CORTA}
                            </p>
                        </div>
                    </div>
                </div>
            `;
      innerContainer.appendChild(slide);

      // Indicator
      const dot = document.createElement('button');
      dot.className = `w-2 h-2 rounded-full transition-all duration-300 ${index === 0 ? 'bg-red-700 w-4' : 'bg-white/50 hover:bg-white'}`;
      dot.onclick = (e) => {
        e.stopPropagation();
        goToSlide(index);
      };
      indicators.appendChild(dot);
    });

    // Start Autoplay
    if (items.length > 1) {
      startCarousel(items.length);

      // Swipe Listeners
      const carousel = document.getElementById('heroSection'); // Swipe on the whole section
      carousel.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      carousel.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe(items.length);
      }, { passive: true });
    }
  }

  function handleSwipe(total) {
    const threshold = 50;
    if (touchEndX < touchStartX - threshold) {
      // Swipe Left -> Next
      const next = (currentSlide + 1) % total;
      goToSlide(next);
      startCarousel(total); // Reset timer
    }
    if (touchEndX > touchStartX + threshold) {
      // Swipe Right -> Prev
      const prev = (currentSlide - 1 + total) % total;
      goToSlide(prev);
      startCarousel(total); // Reset timer
    }
  }

  function startCarousel(total) {
    if (carouselInterval) clearInterval(carouselInterval);
    carouselInterval = setInterval(() => {
      const next = (currentSlide + 1) % total;
      goToSlide(next);
    }, 5000); // 5 Seconds Interval
  }

  function goToSlide(index) {
    const slides = document.querySelectorAll('#carouselContainer > div');
    const dots = document.querySelectorAll('#carouselIndicators button');

    if (!slides[currentSlide]) return; // Safety

    // Hide Current
    slides[currentSlide].classList.add('carousel-hidden');
    slides[currentSlide].classList.add('opacity-0');
    dots[currentSlide].className = 'w-2 h-2 rounded-full bg-white/50 hover:bg-white transition-all duration-300';

    // Show New
    currentSlide = index;
    slides[currentSlide].classList.remove('carousel-hidden');
    slides[currentSlide].classList.remove('opacity-0');
    dots[currentSlide].className = 'w-4 h-2 rounded-full bg-red-700 transition-all duration-300';
  }

  // --- Navigation Logic ---

  function renderDashboard(groups) {
    const view = document.getElementById('dashboardView');
    view.classList.remove('hidden');
    view.classList.add('fade-in');

    document.getElementById('detailView').classList.add('hidden');
    document.getElementById('emptyState').classList.add('hidden');

    const container = document.getElementById('categoryButtonsGrid');
    container.innerHTML = '';

    const categories = Object.keys(groups).sort();

    categories.forEach((cat, index) => {
      const count = groups[cat].length;
      const icon = CATEGORY_ICONS[cat] || 'folder';

      const btn = document.createElement('div');
      btn.className = "bg-white/90 p-4 h-28 rounded-2xl shadow-sm border border-white/40 hover:shadow-lg hover:border-aesa-blue transition-all duration-300 cursor-pointer group relative card-anim mining-surface";
      btn.style.animationDelay = `${index * 0.05}s`;
      btn.onclick = () => showCategoryDetail(cat);

      btn.innerHTML = `
                <div class="h-full flex flex-col justify-between min-w-0 pr-6">
                    <h3 class="font-bold text-xl text-aesa-dark font-condensed uppercase tracking-wide group-hover:text-aesa-blue transition-colors leading-tight break-words whitespace-normal group-title-clamp pr-0">${cat}</h3>
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-11 h-11 rounded-full bg-white flex items-center justify-center shadow-sm shrink-0">
                            <span class="material-icons text-amber-500 text-[22px] leading-none">folder</span>
                        </div>
                        <p class="text-slate-600 text-sm leading-tight font-medium">${count} Elementos</p>
                    </div>
                </div>
                <span class="material-icons absolute right-2 top-1/2 -translate-y-1/2 text-gray-300 group-hover:text-aesa-blue group-hover:translate-x-0.5 transition-all text-lg">chevron_right</span>
            `;
      applyLanternEffect(btn);
      container.appendChild(btn);
    });
  }

  function showCategoryDetail(categoryName) {
    document.getElementById('dashboardView').classList.add('hidden');
    const detailView = document.getElementById('detailView');
    detailView.classList.remove('hidden');
    detailView.classList.add('fade-in');

    document.getElementById('currentCategoryTitle').textContent = categoryName;

    currentCategoryItems = groupedData[categoryName] || [];
    displayedItemsCount = 0;
    const grid = document.getElementById('cardsGrid');
    grid.innerHTML = '';

    // Create Load More Button Container if it doesn't exist
    let loadMoreContainer = document.getElementById('loadMoreContainer');
    if (!loadMoreContainer) {
      loadMoreContainer = document.createElement('div');
      loadMoreContainer.id = 'loadMoreContainer';
      loadMoreContainer.className = 'col-span-full flex justify-center mt-8 mb-4';
      detailView.appendChild(loadMoreContainer);
    } else {
      loadMoreContainer.innerHTML = '';
    }

    loadMoreItems();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function loadMoreItems() {
    const grid = document.getElementById('cardsGrid');
    const loadMoreContainer = document.getElementById('loadMoreContainer');

    const nextItems = currentCategoryItems.slice(displayedItemsCount, displayedItemsCount + ITEMS_PER_PAGE);

    nextItems.forEach((item, index) => {
      const card = createCard(item);
      card.classList.add('card-anim');
      card.style.animationDelay = `${index * 0.05}s`;
      grid.appendChild(card);
    });

    displayedItemsCount += nextItems.length;

    if (displayedItemsCount >= currentCategoryItems.length) {
      loadMoreContainer.innerHTML = ''; // Hide button if all elements are shown
    } else {
      loadMoreContainer.innerHTML = `<button onclick="loadMoreItems()" class="bg-gray-100/50 hover:bg-gray-200/80 text-aesa-blue font-bold px-8 py-2.5 rounded-full border-2 border-aesa-blue transition-colors duration-300 shadow-md transform hover:scale-105">Cargar más documentos...</button>`;
    }
  }

  function showDashboard() {
    document.getElementById('detailView').classList.add('hidden');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('searchInput').value = '';

    const dashboard = document.getElementById('dashboardView');
    dashboard.classList.remove('hidden');
    dashboard.classList.add('fade-in');

    renderDashboard(groupedData);
  }

  function createCard(item, highlightTerm = '') {
    const div = document.createElement('article');
    div.className = "bg-white/95 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 border border-gray-200 flex flex-col h-full card-hover cursor-pointer group card-item flashlight-card";
    div.dataset.title = (item.TITULO || "").toLowerCase();
    div.dataset.desc = (item.DESCRIPCION_CORTA || "").toLowerCase();
    div.onclick = () => openModal(item);

    const imgUrl = (item.LINK_FOTO && item.LINK_FOTO.toString().trim() !== "") ? item.LINK_FOTO : FALLBACK_IMAGE;

    // Highlight Logic
    let titleHtml = item.TITULO;
    let descHtml = item.DESCRIPCION_CORTA;

    if (highlightTerm) {
      const regex = new RegExp(`(${highlightTerm})`, 'gi');
      titleHtml = titleHtml.replace(regex, '<mark>$1</mark>');
      descHtml = descHtml.replace(regex, '<mark>$1</mark>');
    }

    div.innerHTML = `
            <div class="h-28 overflow-hidden relative bg-gray-100">
                <img src="${imgUrl}" alt="${item.TITULO}" loading="lazy" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500" onerror="this.src='${FALLBACK_IMAGE}'">
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300"></div>
            </div>
            <div class="p-3 flex flex-col flex-grow bg-white">
                <h3 class="text-sm font-bold font-condensed text-aesa-dark mb-1 leading-tight group-hover:text-aesa-blue transition-colors line-clamp-2">
                    ${titleHtml}
                </h3>
                <p class="text-[11px] text-gray-500 line-clamp-2 mb-3 flex-grow leading-snug">
                    ${descHtml}
                </p>
                <div class="mt-auto border-t border-gray-50 pt-2">
                    <button class="text-[11px] font-bold text-white bg-aesa-blue hover:bg-blue-900 w-full py-1.5 rounded transition-colors uppercase tracking-wide opacity-90 hover:opacity-100 shadow-sm group-hover:shadow hover:translate-y-px">
                        VER
                    </button>
                </div>
            </div>
        `;

    applyLanternEffect(div);

    return div;
  }

  // --- Interaction Functions ---

  function handleSearchDebounced(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      handleSearch(e);
    }, 350); // 350ms Debounce
  }

  function handleSearch(e) {
    const term = e.target.value.toLowerCase().trim();
    const resultsContainer = document.getElementById('searchResultsOverlay');

    if (term === '') {
      resultsContainer.innerHTML = `
            <div class="col-span-full text-center text-gray-500 mt-20">
                <span class="material-icons text-6xl mb-4 opacity-50">manage_search</span>
                <p class="text-xl">Escribe para comenzar a buscar...</p>
            </div>
        `;
      return;
    }

    resultsContainer.innerHTML = '';
    let foundCount = 0;

    // Search in all data
    Object.values(groupedData).flat().forEach((item, index) => {
      const title = (item.TITULO || "").toLowerCase();
      const desc = (item.DESCRIPCION_CORTA || "").toLowerCase();

      if (title.includes(term) || desc.includes(term)) {
        const card = createCard(item, term);
        card.onclick = () => {
          closeSearch();
          openModal(item);
        };

        card.classList.add('card-anim');
        card.style.animationDelay = `${foundCount * 0.05}s`;
        resultsContainer.appendChild(card);
        foundCount++;
      }
    });

    if (foundCount === 0) {
      resultsContainer.innerHTML = `
            <div class="col-span-full text-center text-gray-500 mt-20">
                <span class="material-icons text-6xl mb-4 opacity-50">search_off</span>
                <p class="text-xl">No se encontraron resultados para "${term}"</p>
                <p class="text-sm mt-2">Intenta con otros términos.</p>
            </div>
        `;
    }
  }

  function showEmptyState(show) {
    // Kept for compatibility but not used in overlay search
    const emptyEl = document.getElementById('emptyState');
    if (show) {
      emptyEl.classList.remove('hidden');
      document.getElementById('dashboardView').classList.add('hidden');
    } else {
      emptyEl.classList.add('hidden');
    }
  }

  function hideLoader() {
    const loader = document.getElementById('loadingOverlay');
    loader.style.opacity = '0';
    setTimeout(() => {
      loader.classList.add('hidden');
    }, 500);
  }

  function sanitizeHTML(str) {
    if (!str) return '';
    // Elimina tags <script>, eventos 'on' y el prefijo 'javascript:'
    return str.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
      .replace(/\bon\w+\s*=/gi, '')
      .replace(/javascript:/gi, '#');
  }

  function renderDescriptionContent(rawDescription, category) {
    const descEl = document.getElementById('modalDescription');
    if (!descEl) return;

    let value = String(rawDescription || "Sin descripción disponible.");
    value = sanitizeHTML(value);
    const normalizedCategory = String(category || "").trim().toUpperCase();

    if (normalizedCategory === 'PAC') {
      descEl.style.whiteSpace = 'normal';
      const parser = new DOMParser();
      const doc = parser.parseFromString(value, 'text/html');
      const tableEl = doc.querySelector('table');
      if (tableEl) {
        const rows = tableEl.querySelectorAll('tbody tr');
        rows.forEach((row) => {
          const cells = row.querySelectorAll('td');
          // Col 1: Examen, Col 2: Presentacion, Col 3: Video
          const map = [
            { idx: 1, cls: 'btn-examen', label: 'Rendir' },
            { idx: 2, cls: 'btn-presentacion', label: 'Ver' },
            { idx: 3, cls: 'btn-video', label: 'Ver' }
          ];
          map.forEach(({ idx, cls, label }) => {
            const cell = cells[idx];
            if (!cell) return;
            const anchor = cell.querySelector('a');
            if (!anchor) return;
            anchor.classList.remove('btn-examen', 'btn-presentacion', 'btn-video');
            anchor.classList.add('btn', cls);
            anchor.textContent = label;
            anchor.setAttribute('target', '_blank');
            anchor.setAttribute('rel', 'noopener noreferrer');
          });
        });
      }
      const tableHtml = tableEl ? tableEl.outerHTML : (doc.body ? doc.body.innerHTML : value);

      descEl.innerHTML = `
        <style>
          #modalDescription .pac-html-content{
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            background:linear-gradient(135deg,#f4f6f9,#e9eef5);
            padding:8px 10px;
            border-radius:12px;
          }
          #modalDescription .pac-note{
            margin:0 0 6px 0;
            color:#1f2937;
            font-weight:600;
            font-size:14px;
          }
          #modalDescription .pac-table-container{
            max-width:100%;
            margin:auto;
            overflow-x:auto;
          }
          #modalDescription .pac-table-container table{
            width:100%;
            border-collapse:collapse;
            background:#fff;
            border-radius:12px;
            overflow:hidden;
            box-shadow:0 8px 20px rgba(0,0,0,0.08);
            margin-top:0;
          }
          #modalDescription .pac-table-container thead{
            background:#1f2937;
            color:#fff;
          }
          #modalDescription .pac-table-container th,
          #modalDescription .pac-table-container td{
            padding:12px;
            text-align:center;
            font-size:13px;
          }
          #modalDescription .pac-table-container tbody tr{
            transition:0.3s ease;
          }
          #modalDescription .pac-table-container tbody tr:hover{
            background:#f3f4f6;
          }
          #modalDescription .pac-table-container .btn{
            display:inline-block;
            padding:7px 12px;
            border-radius:8px;
            text-decoration:none;
            font-weight:600;
            font-size:12px;
            color:#fff;
            transition:0.3s ease;
          }
          #modalDescription .pac-table-container .btn-examen{ background:#2563eb; }
          #modalDescription .pac-table-container .btn-examen:hover{ background:#1d4ed8; }
          #modalDescription .pac-table-container .btn-presentacion{ background:#10b981; }
          #modalDescription .pac-table-container .btn-presentacion:hover{ background:#059669; }
          #modalDescription .pac-table-container .btn-video{ background:#f59e0b; }
          #modalDescription .pac-table-container .btn-video:hover{ background:#d97706; }
        </style>
        <div class="pac-html-content">
          <p class="pac-note">A continuación las capacitaciones del mes:</p>
          <div class="pac-table-container">${tableHtml}</div>
        </div>
      `;
      return;
    }

    const hasHtml = /<\/?[a-z][\s\S]*>/i.test(value);

    if (hasHtml) {
      descEl.style.whiteSpace = 'normal';
      // If HTML is present (or mixed with text), render preserving original order.
      // Normalize full HTML documents (<html>/<head>/<body>) to avoid large spacing from body styles.
      const parser = new DOMParser();
      const doc = parser.parseFromString(value, 'text/html');

      const styleBlocks = Array.from(doc.querySelectorAll('style'))
        .map((styleEl) => styleEl.textContent || '')
        .join('\n');

      // Scope "body { ... }" styles to modal content and neutralize padding/margins.
      const scopedStyles = styleBlocks
        .replace(/\bbody\s*\{/gi, '.modal-html-content {')
        .concat('\n.modal-html-content{padding:0 !important;margin:0 !important;background:transparent !important;}');

      // Keep original order of text + HTML as found in body content.
      const bodyContent = doc.body ? doc.body.innerHTML : value;
      descEl.innerHTML = `<style>${scopedStyles}</style><div class="modal-html-content">${bodyContent}</div>`;
      return;
    }

    descEl.style.whiteSpace = 'pre-line';
    descEl.textContent = value;
  }

  function openModal(item) {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContainer');

    document.getElementById('modalTitle').textContent = item.TITULO;
    renderDescriptionContent(item.DESCRIPCION_LARGA || item.DESCRIPCION_CORTA, item.CATEGORIA);
    // Category removed

    let dateStr = "N/A";
    if (item.FECHA) {
      // Robust Date Parsing
      const dateObj = new Date(item.FECHA);
      if (!isNaN(dateObj.getTime())) {
        dateStr = dateObj.toLocaleDateString();
      } else {
        dateStr = String(item.FECHA); // Fallback to raw string
      }
    }
    document.getElementById('modalDate').textContent = dateStr;

    // Link CTA at the end of description
    const linkBtn = document.getElementById('modalLink');

    if (item.LINK_INFORMACION && item.LINK_INFORMACION !== "#" && item.LINK_INFORMACION.trim() !== "") {
      linkBtn.classList.remove('hidden');
      linkBtn.classList.add('inline-flex');
      linkBtn.href = item.LINK_INFORMACION;
    } else {
      linkBtn.classList.add('hidden');
      linkBtn.classList.remove('inline-flex');
    }

    const imgContainer = document.getElementById('modalImageContainer');
    const img = document.getElementById('modalImage');
    const imgUrl = (item.LINK_FOTO && item.LINK_FOTO.toString().trim() !== "") ? item.LINK_FOTO : FALLBACK_IMAGE;
    img.src = imgUrl;
    if (imgContainer) {
      imgContainer.classList.remove('hidden');
    } else {
      img.classList.remove('hidden');
    }

    modal.classList.remove('hidden');
    setTimeout(() => {
      modalContent.classList.remove('scale-95');
      modalContent.classList.add('scale-100');
    }, 10);
  }

  function closeModal() {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContainer');
    modalContent.classList.remove('scale-100');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 200);
  }

  // --- Search Overlay Functions ---

  function openSearch() {
    const overlay = document.getElementById('searchOverlay');
    const input = document.getElementById('searchInput');
    overlay.classList.remove('hidden');
    // Focus after transition/render
    setTimeout(() => input.focus(), 100);
  }

  function closeSearch() {
    const overlay = document.getElementById('searchOverlay');
    overlay.classList.add('hidden');
  }

  // Close search on ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const overlay = document.getElementById('searchOverlay');
      if (!overlay.classList.contains('hidden')) {
        closeSearch();
      }
    }
  });

  // Close search on click outside (optional, but good UX)
  document.getElementById('searchOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'searchOverlay') closeSearch();
  });

  // --- Funciones de Zoom de Imagen ---
  // --- Funciones de Zoom de Imagen ---
  let currentZoom = 1;
  let zoomMin = 1;
  let zoomMax = 4;

  let isDragging = false;
  let startX = 0;
  let startY = 0;
  let translateX = 0;
  let translateY = 0;
  let lastTranslateX = 0;
  let lastTranslateY = 0;

  // Variables for pinch-to-zoom
  let initialPinchDistance = null;
  let initialZoom = 1;

  function openZoomModal() {
    const zoomModal = document.getElementById('zoomModal');
    const zoomImage = document.getElementById('zoomModalImage');
    const sourceImage = document.getElementById('modalImage');

    zoomImage.src = sourceImage.src;
    zoomModal.classList.remove('hidden');

    // Reset zoom and translations
    currentZoom = 1;
    translateX = 0;
    translateY = 0;
    lastTranslateX = 0;
    lastTranslateY = 0;
    updateZoomTransform();

    // Attach event listeners when modal opens
    zoomModal.addEventListener('wheel', handleWheelZoom, { passive: false });

    // Touch Events for Pinch to Zoom and Panning
    zoomModal.addEventListener('touchstart', handleTouchStart, { passive: false });
    zoomModal.addEventListener('touchmove', handleTouchMove, { passive: false });
    zoomModal.addEventListener('touchend', handleTouchEnd);

    // Mouse Events for Panning (Desktop)
    zoomImage.addEventListener('mousedown', handleMouseDown);
    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mouseup', handleMouseUp);

    // Animación suave de entrada
    setTimeout(() => {
      zoomModal.classList.remove('opacity-0');
      zoomImage.classList.remove('scale-95');
      zoomImage.classList.add('scale-100');
    }, 10);
  }

  function closeZoomModal() {
    const zoomModal = document.getElementById('zoomModal');
    const zoomImage = document.getElementById('zoomModalImage');

    zoomModal.classList.add('opacity-0');
    zoomImage.classList.remove('scale-100');
    zoomImage.classList.add('scale-95');

    // Remove event listeners
    zoomModal.removeEventListener('wheel', handleWheelZoom);
    zoomModal.removeEventListener('touchstart', handleTouchStart);
    zoomModal.removeEventListener('touchmove', handleTouchMove);
    zoomModal.removeEventListener('touchend', handleTouchEnd);

    zoomImage.removeEventListener('mousedown', handleMouseDown);
    window.removeEventListener('mousemove', handleMouseMove);
    window.removeEventListener('mouseup', handleMouseUp);

    setTimeout(() => {
      zoomModal.classList.add('hidden');
    }, 300);
  }

  function updateZoomTransform() {
    const zoomImage = document.getElementById('zoomModalImage');
    if (zoomImage) {
      // Constrain translations to prevent dragging out of view
      if (currentZoom === 1) {
        translateX = 0;
        translateY = 0;
      }

      zoomImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;

      // Update cursor based on zoom state
      if (currentZoom > 1) {
        zoomImage.style.cursor = 'grab';
        if (isDragging) zoomImage.style.cursor = 'grabbing';
      } else {
        zoomImage.style.cursor = 'zoom-in';
      }
    }
  }

  // --- PC Wheel Zoom ---
  function handleWheelZoom(e) {
    e.preventDefault();
    const zoomStep = 0.2;

    if (e.deltaY < 0) {
      // Scroll up (zoom in)
      currentZoom = Math.min(currentZoom + zoomStep, zoomMax);
    } else {
      // Scroll down (zoom out)
      currentZoom = Math.max(currentZoom - zoomStep, zoomMin);
    }

    updateZoomTransform();
  }

  // --- Touch Events (Mobile Pinch/Pan) ---
  function getPinchDistance(touches) {
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function handleTouchStart(e) {
    if (e.touches.length === 2) {
      // Pinch start
      initialPinchDistance = getPinchDistance(e.touches);
      initialZoom = currentZoom;
      isDragging = false;
    } else if (e.touches.length === 1 && currentZoom > 1) {
      // Pan start
      isDragging = true;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      lastTranslateX = translateX;
      lastTranslateY = translateY;
    }
  }

  function handleTouchMove(e) {
    if (e.touches.length === 2 && initialPinchDistance !== null) {
      e.preventDefault(); // Prevent native scroll

      const currentDistance = getPinchDistance(e.touches);

      // Calcular ratio de pellizco, amplificarlo por sensibilidad (e.g. ^ 1.5 o log)
      // Una progresión geométrica ligera da mejor efecto: (d2 / d1) ^ 1.3
      const pinchRatio = Math.pow(currentDistance / initialPinchDistance, 1.5);

      // Calculate new zoom smoothly
      let newZoom = initialZoom * pinchRatio;
      currentZoom = Math.max(zoomMin, Math.min(newZoom, zoomMax));

      updateZoomTransform();
    } else if (e.touches.length === 1 && isDragging) {
      e.preventDefault(); // Prevent native scroll

      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;

      translateX = lastTranslateX + dx;
      translateY = lastTranslateY + dy;

      updateZoomTransform();
    }
  }

  function handleTouchEnd(e) {
    initialPinchDistance = null;
    if (e.touches.length === 0) {
      isDragging = false;
      lastTranslateX = translateX;
      lastTranslateY = translateY;
      updateZoomTransform(); // update cursor class
    }
  }

  // --- Mouse Events (Pan on PC) ---
  function handleMouseDown(e) {
    if (currentZoom > 1) {
      e.preventDefault();
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      lastTranslateX = translateX;
      lastTranslateY = translateY;
      updateZoomTransform();
    }
  }

  function handleMouseMove(e) {
    if (isDragging && currentZoom > 1) {
      e.preventDefault();
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      translateX = lastTranslateX + dx;
      translateY = lastTranslateY + dy;

      updateZoomTransform();
    }
  }

  function handleMouseUp() {
    if (isDragging) {
      isDragging = false;
      lastTranslateX = translateX;
      lastTranslateY = translateY;
      updateZoomTransform();
    }
  }

  // --- Funciones de Modal de Emergencia ---
  function openEmergencyModal() {
    const modal = document.getElementById('emergencyModal');
    const img = document.getElementById('emergencyImage');
    img.src = EMERGENCY_IMAGE_URL;

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    // Animación suave de entrada
    setTimeout(() => {
      modal.classList.remove('opacity-0');
    }, 10);
  }

  function closeEmergencyModal() {
    const modal = document.getElementById('emergencyModal');
    if (modal) {
      modal.classList.add('opacity-0');
      setTimeout(() => {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }, 300); // 300ms de transición CSS
    }
  }
</script>